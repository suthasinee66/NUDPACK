<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NUDPACK Admin</title>

  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai+Looped:wght@100..900&display=swap"
    rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: { primary: "#f95f06" },
          fontFamily: { display: ["Noto Sans Thai Looped", "sans-serif"] }
        }
      }
    }
  </script>

  <style>
    .scan-zone {
      border: 2px dashed #e9d8ce
    }

    .latest {
      background: #fff6e5
    }

    .modeBtn {
      text-align: center;
      padding: 10px 0;
      border-radius: 10px;
      cursor: pointer;
      transition: .2s;
      background: white;
    }

    .activeMode {
      background: #f95f06;
      color: white;
      box-shadow: 0 4px 10px rgba(249, 95, 6, .3);
    }

    input[type="radio"] {
      display: none !important;
    }
  </style>
</head>

<body class="bg-[#fafafa] font-display" onload="loadWaitingParcels()">

  <header class="sticky top-0 bg-white/80 backdrop-blur border-b p-4">
    <div class="max-w-xl mx-auto flex justify-between items-center">
      <div class="flex gap-3 items-center">
        <img src="/static/NUDPACK_LOGO2.png" class="w-14" />
        <div>
          <h2 class="font-bold">NUDPACK ADMIN</h2>
          <p class="text-xs text-orange-400">Parcel Checkout</p>
        </div>
      </div>

      <button onclick="logout()" class="text-xs text-red-500">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
  </header>

  <main class="max-w-xl mx-auto pb-40">

    <!-- ================= Scan ================= -->
    <section class="p-4">
      <div class="bg-white rounded-xl p-4 scan-zone">

        <label class="text-sm text-primary font-semibold">Scan / Enter Tracking</label>

        <div class="flex mt-2">
          <input id="scanInput" class="flex-1 border rounded-l-lg h-12 px-3" />

          <button onclick="handleScan(scanInput.value.trim())" class="bg-primary text-white px-4 rounded-r-lg">
            <span class="material-symbols-outlined">barcode_scanner</span>
          </button>
        </div>

        <div class="flex gap-3 mt-4">
          <button onclick="startCamera()"
            class="flex-1 bg-primary text-white rounded-lg h-12 flex justify-center items-center gap-2">
            <span class="material-symbols-outlined">photo_camera</span>‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
          </button>
          <button onclick="stopCamera()" class="flex-1 border rounded-lg h-12">‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
        </div>

        <div id="cameraOverlay" class="fixed inset-0 bg-black/70 hidden z-50 flex items-center justify-center">

          <div class="bg-white rounded-2xl p-4 w-80 shadow-xl">

            <div id="reader"></div>

            <button onclick="stopCamera()" class="mt-4 w-full bg-orange-500 text-white py-2 rounded-xl">
              ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
            </button>

          </div>

        </div>
        <div id="scanStatus" class="text-sm mt-2"></div>

      </div>
    </section>
<section class="px-4 mt-2">
  

    <!-- queue search -->
    <input
      id="queueSearch"
      placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏¥‡∏ß"
      oninput="searchQueue(this.value)"
      class="border px-4 py-2 rounded-xl text-sm w-40 shadow-sm
             focus:ring-2 focus:ring-orange-400 focus:outline-none"
    >

    <!-- search date -->
    


  </div>
</section>
<section class="px-4 mt-2">
  <div class="mb-3 flex gap-2 items-center">
<div class="mb-3 flex gap-2 items-center">

    <!-- date -->
    <input
  id="dateFilter"
  type="text"
  placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"
  onfocus="this.type='date'"
  onblur="if(!this.value)this.type='text'"
  class="border px-2 py-2 rounded-lg text-xs shadow-sm w-28
         focus:ring-2 focus:ring-orange-400 focus:outline-none"
/>
             
    <!-- today -->
    <button
      onclick="clearDateFilter()"
      class="border px-4 py-2 rounded-xl text-sm hover:bg-gray-50"
    >
      ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
    </button>

    <!-- all -->
    <button
      onclick="loadWaitingParcels()"
      class="border px-4 py-2 rounded-xl text-sm hover:bg-gray-50"
    >
      ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô
    </button>
    <button
      onclick="applyDateFilter()"
      class="bg-orange-500 hover:bg-orange-600 transition text-white px-4 py-2 rounded-xl text-sm shadow"
    >
      ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    </button>
  </div>
</section>
    
    

    <!-- ================= Parcel List ================= -->
    <section class="px-4 mt-3">
  <div class="flex items-center justify-between mb-2">

    <h3 class="font-semibold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏™‡∏î‡∏∏</h3>

    <!-- status filter (small right side) -->
    <select
      id="statusFilter"
      onchange="loadWaitingParcels()"
      class="appearance-none rounded-lg border border-gray-300 bg-white
             px-3 py-1.5 text-xs w-36
             shadow-sm transition
             hover:border-orange-300
             focus:outline-none focus:ring-2 focus:ring-orange-400 focus:border-orange-400"
    >
      <option value="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" selected>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
      <option value="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</option>
      <option value="‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß">‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</option>
      <option value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠</option>
    </select>

  </div>

  <div id="parcelList" class="flex flex-col gap-2"></div>
</section>





  </main>


  <!-- popup -->
  <div id="queuePopup" class="fixed inset-0 hidden bg-black/40 items-center justify-center">
    <div class="bg-white rounded-xl p-6 w-72 text-center">
      <p class="text-gray-400 text-sm">Queue</p>
      <div id="popupQueue" class="text-6xl text-primary font-bold"></div>
      <p id="popupTracking" class="text-xs text-gray-500 mt-2"></p>
      <button onclick="closePopup()" class="mt-4 w-full bg-primary text-white rounded-lg py-2">‡∏ï‡∏Å‡∏•‡∏á</button>
    </div>
  </div>

  <!-- Pending Verify Popup -->
  <div id="pendingPopup" class="fixed inset-0 hidden bg-black/40 items-center justify-center z-50">
    <div class="bg-white rounded-xl p-5 w-[90%] max-w-md relative">

      <!-- close -->
      <button onclick="forceClearPending()" class="absolute right-3 top-3 text-gray-400 hover:text-red-500 text-xl">
        ‚úï
      </button>

      <h3 class="font-bold mb-2 text-primary">Pending Verification</h3>

      <div id="verifyBox"></div>
      <div id="readerConfirm" class="mt-3"></div>

    </div>
  </div>

  <!-- Already Picked Popup -->
  <div id="alreadyPopup" class="fixed inset-0 hidden bg-black/40 items-center justify-center z-50">
    <div class="bg-white rounded-xl p-5 w-[90%] max-w-md relative">

      <button onclick="closeAlreadyPopup()" class="absolute right-3 top-3 text-gray-400 hover:text-red-500 text-xl">
        ‚úï
      </button>

      <h3 class="font-bold text-red-500 mb-2">‚ö† ‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</h3>

      <div id="alreadyBox" class="text-sm"></div>

      <button onclick="closeAlreadyPopup()" class="mt-4 w-full bg-primary text-white rounded-lg py-2">
        ‡∏ï‡∏Å‡∏•‡∏á
      </button>

    </div>
  </div>

  <!-- Recipient Required Popup -->
  <div id="recipientPopup" class="fixed inset-0 hidden bg-black/40 items-center justify-center z-50">
    <div class="bg-white rounded-xl p-5 w-72 text-center">

      <h3 class="font-bold text-primary mb-2">‚ö† ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</h3>

      <p class="text-sm text-gray-600">
        ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πÅ‡∏Å‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
      </p>

      <button onclick="closeRecipientPopup()" class="mt-4 w-full bg-primary text-white rounded-lg py-2">
        ‡∏ï‡∏Å‡∏•‡∏á
      </button>

    </div>
  </div>
  <!-- Mismatch Popup -->
  <div id="mismatchPopup" class="fixed inset-0 hidden bg-black/40 items-center justify-center z-50">
    <div class="bg-white rounded-xl p-5 w-72 text-center">

      <h3 class="font-bold text-red-500 mb-2">‚ùå ‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á</h3>

      <p class="text-sm text-gray-600">
        ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
      </p>

      <button onclick="closeMismatchPopup()" class="mt-4 w-full bg-primary text-white rounded-lg py-2">
        ‡∏ï‡∏Å‡∏•‡∏á
      </button>

    </div>
  </div>
  <div id="confirmCameraOverlay" class="fixed inset-0 bg-black/70 hidden z-50 flex items-center justify-center">

    <div class="bg-white rounded-2xl p-4 w-80 shadow-xl">

      <div id="confirmReader"></div>

      <button onclick="stopConfirmCamera()" class="mt-4 w-full bg-orange-500 text-white py-2 rounded-xl">
        ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
      </button>

    </div>

  </div>
  <!-- Not Found Popup -->
  <div id="notFoundPopup" class="fixed inset-0 hidden bg-black/40 items-center justify-center z-50">
    <div class="bg-white rounded-xl p-5 w-72 text-center">

      <h3 class="font-bold text-red-500 mb-2">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏</h3>

      <p class="text-sm text-gray-600">
        ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
      </p>

      <button onclick="closeNotFoundPopup()" class="mt-4 w-full bg-primary text-white rounded-lg py-2">
        ‡∏ï‡∏Å‡∏•‡∏á
      </button>

    </div>
  </div>

  <div id="successPopup"
 class="fixed inset-0 hidden items-center justify-center bg-black/40 z-50">

  <div class="bg-white rounded-2xl p-8 flex flex-col items-center w-72">

    <!-- orange check -->
    <div class="w-20 h-20 rounded-full bg-orange-500 flex items-center justify-center shadow-lg">
      <span class="material-symbols-outlined text-white text-5xl">check</span>
    </div>

    <div class="mt-4 text-lg font-semibold">
      ‡∏£‡∏±‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß
    </div>

    <div id="successInfo"
         class="mt-2 text-sm text-gray-500 text-center"></div>

    <!-- OK button -->
    <button onclick="closeSuccessPopup()"
      class="mt-5 bg-orange-500 hover:bg-orange-600 text-white px-6 py-2 rounded-lg">
      ‡∏ï‡∏Å‡∏•‡∏á
    </button>

  </div>
</div>
  <script>
    /* ---------------- Tabs ---------------- */
    document.querySelectorAll('.tabBtn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tabBtn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const tab = btn.dataset.tab;
        document.querySelectorAll('.tabContent').forEach(tc => tc.style.display = tc.id === tab ? 'block' : 'none');
        if (tab === 'reports') initReports();
      });
    });

    /* ---------- Globals ---------- */
    let pendingVerification = null;

    // scanners (‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô function ‡πÉ‡∏î ‡πÜ)
    let mainScanner = null;
    let confirmScanner = null;
    let cameraLocked = false;
    let confirmStopping = false


    /* ---------- Scan input handling ---------- */
    const scanInputEl = document.getElementById('scanInput');
    scanInputEl.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleScan(scanInputEl.value.trim());
    });

    async function handleScan(value) {
      if (!value) return;
      // first scan -> verify
      if (!pendingVerification) {
        setStatus('verifying...');
        try {
          const res = await fetch(`/api/parcels/${encodeURIComponent(value)}/verify`, { method: 'POST' });
          if (!res.ok) {

            // ===== ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏ =====
            if (res.status === 404) {
              openNotFoundPopup()
              setStatus("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö")
              scanInputEl.value = ''
              return
            }

            const err = await safeJson(res).catch(() => ({ detail: res.statusText }));
            setStatus('Verify failed: ' + (err.detail || res.statusText));
            scanInputEl.value = '';
            return;
          }
          const info = await res.json();
          // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚Üí popup ‡πÅ‡∏à‡πâ‡∏á
          if (info.status === "PICKED_UP" || info.status === "‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß") {

            document.getElementById("alreadyBox").innerHTML = `
              <div><b>Tracking:</b> ${escapeHtml(info.tracking)}</div>
              <div><b>Queue:</b> ${escapeHtml(info.queue_number || info.queue || "-")}</div>
              <div><b>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö:</b> ${escapeHtml(info.recipient_name || info.recipient || "-")}</div>
              <div><b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</b> ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÅ‡∏•‡πâ‡∏ß</div>
              <div><b>‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö:</b> ${escapeHtml(info.picked_up_at ? new Date(info.picked_up_at).toLocaleString("th-TH", { timeZone: "Asia/Bangkok" }) : "-")}</div>
            `

            openAlreadyPopup()
            setStatus("‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß")
            scanInputEl.value = ""
            return
          }

          const recipientName = info.recipient_name ?? info.recipient ?? '';
          pendingVerification = {
            tracking: info.tracking,
            queue: info.queue_number || info.queue || '',
            recipient: recipientName,
            ts: Date.now()
          };
          renderPendingBox();
          openPendingPopup();
          showDetail(info);

          setStatus('Verified ‚Äî please fill recipient and re-enter tracking to confirm (or scan same tracking again).');
        } catch (err) {
          setStatus('Network error: ' + err);
        } finally {
          scanInputEl.value = '';
        }
        return;
      }

      // second scan -> if matches, perform confirm using recipient in pending box
      if (value === pendingVerification.tracking) {
        const recipientInput = document.getElementById('pendingRecipientInput');
        const recipientToSend = recipientInput ? recipientInput.value.trim() : (pendingVerification.recipient || '');
        await doConfirmPickup(pendingVerification.tracking, recipientToSend);
        return;
      } else {
        openMismatchPopup()
      }
    }

    /* ---------- Render pending verification box ---------- */
    function renderPendingBox() {
      if (!pendingVerification) {
        document.getElementById('verifyBox').innerHTML = '';
        return;
      }
      const rec = pendingVerification.recipient || '';
      document.getElementById('verifyBox').innerHTML = `

  <div>
    <strong>‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô:</strong>
    ${escapeHtml(pendingVerification.tracking)}
    <strong>‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏¥‡∏ß:</strong>
    ${escapeHtml(pendingVerification.queue)}
  </div>

  <div class="small" style="margin-top:6px">
    ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö :<br>
    <input id="pendingRecipientInput"
      style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd"
      value="${escapeAttr(rec)}"
      placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ï‡∏£‡∏ô‡∏¥‡∏™‡∏¥‡∏ï" />
  </div>
<!-- Confirm mode toggle -->
<div class="mt-3 flex bg-white rounded-xl p-1 text-sm shadow-lg shadow-orange-200/60">

<label class="flex-1">
<input type="radio" name="confirmMode" value="scan"  hidden>

<div class="modeBtn" data-mode="scan">üì∑ ‡∏™‡πÅ‡∏Å‡∏ô</div>
</label>

<label class="flex-1">
<input type="radio" name="confirmMode" value="manual" hidden>

<div class="modeBtn" data-mode="manual">‚å®Ô∏è ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á</div>
</label>

</div>
  <div id="manualConfirmBox" style="margin-top:8px;display:none">

  ‡∏Å‡∏£‡∏≠‡∏Å Tracking ‡∏ã‡πâ‡∏≥:

  <input id="pendingConfirmTracking"
    style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd"
    placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå Tracking ‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á" />

</div>

  <div class="small" style="margin-top:8px">
    ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô:
    <ul style="margin:6px 0 0 18px;padding:0">
      <li>‡∏™‡πÅ‡∏Å‡∏ô Tracking ‡πÄ‡∏î‡∏¥‡∏°‡∏ã‡πâ‡∏≥‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</li>
      <li>‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå Tracking ‡∏•‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏‚Äù</li>
    </ul>
  </div>

  <div style="margin-top:12px" class="flex gap-2">
    <button id="pendingConfirmBtn"
      class="flex-1 bg-primary text-white rounded-lg py-2 disabled:opacity-40"
      disabled>
      ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏
    </button>


    <button class="flex-1 border rounded-lg py-2 text-red-500"
      onclick="forceClearPending()">
      ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
    </button>
  </div>

</div>`;


      const confirmField = document.getElementById('pendingConfirmTracking');
      const recipientField = document.getElementById('pendingRecipientInput');
      const confirmBtn = document.getElementById('pendingConfirmBtn');

      function updatePendingControls() {
        const a = (recipientField.value || '').trim().length > 0;
        const b = (confirmField.value || '').trim().length > 0 && (confirmField.value.trim() === pendingVerification.tracking);
        confirmBtn.disabled = !(a && b);
      }

      confirmField.addEventListener('input', updatePendingControls);
      recipientField.addEventListener('input', updatePendingControls);

      confirmBtn.addEventListener('click', async () => {
        const recipientToSend = (document.getElementById('pendingRecipientInput').value || '').trim();
        await doConfirmPickup(pendingVerification.tracking, recipientToSend);
      });

      let currentMode = null

      document.querySelectorAll(".modeBtn").forEach(btn => {

        btn.onclick = () => {

          const mode = btn.innerText.includes("‡∏Å‡∏£‡∏≠‡∏Å") ? "manual" : "scan"

          // ===== ‡∏Å‡∏î‡∏ã‡πâ‡∏≥ = ‡∏õ‡∏¥‡∏î =====
          if (currentMode === mode) {

            btn.classList.remove("activeMode")
            currentMode = null

            document.getElementById("manualConfirmBox").style.display = "none"

            stopConfirmCamera()

            return
          }

          // ===== ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà =====
          document.querySelectorAll(".modeBtn")
            .forEach(b => b.classList.remove("activeMode"))

          btn.classList.add("activeMode")
          currentMode = mode

          if (mode === "manual") {
            document.getElementById("manualConfirmBox").style.display = "block"
            stopConfirmCamera()
            document.getElementById("pendingConfirmTracking")?.focus()
          }

          if (mode === "scan") {
            document.getElementById("manualConfirmBox").style.display = "none"
            startCameraConfirm()
          }
        }
      })
    }

    /* ---------- Confirm pickup (send recipient_name with request) ---------- */
    async function doConfirmPickup(tracking, recipientToSend) {
      setStatus('confirming pickup...');
      try {
        const res = await fetch(`/api/parcels/${encodeURIComponent(tracking)}/confirm_pickup`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ recipient_name: recipientToSend, scanner_id: 'admin_ui' })
        });
        const j = await safeJson(res);
        if (res.ok && (j.ok === true || j.ok === undefined)) {

showSuccessPopup(
  tracking,
  pendingVerification ? pendingVerification.queue : "",
  recipientToSend
)

setStatus("‡∏£‡∏±‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß")

pendingVerification = null
closePendingPopup()
document.getElementById('verifyBox').innerHTML = ''

refreshRecentIfExists()

} else {
          setStatus('Confirm failed: ' + (j.message || j.detail || JSON.stringify(j)));
        }
      } catch (err) {
        setStatus('Network error: ' + err);
      } finally {
        try { document.getElementById('scanInput').value = ''; } catch (e) { }
      }
    }

    /* Force clear pending */
    function forceClearPending() {
      pendingVerification = null;
      document.getElementById('verifyBox').innerHTML = '';
      closePendingPopup();
      setStatus('waiting');
    }

    /* ---------- Search ---------- */
    document.getElementById('searchInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') doSearch(); });
    async function doSearch() {
      const q = document.getElementById('searchInput').value.trim();
      if (!q) return alert('Please input tracking or queue');
      const res = await fetch(`/api/parcels/search?q=${encodeURIComponent(q)}`);
      if (!res.ok) return alert('Search failed');
      const data = await res.json();
      if (data.count === 0) { document.getElementById('searchResults').innerHTML = '<div class="muted">No results</div>'; return; }
      const rows = data.items.map(i => `<tr>
    <td>${escapeHtml(i.tracking)}</td>
    <td>${escapeHtml(i.queue)}</td>
    <td>${escapeHtml(i.status)}</td>
    <td>${escapeHtml(i.recipient || '')}</td>
    </tr>`).join('');
      document.getElementById('searchResults').innerHTML = `<table><thead><tr><th>tracking</th><th>queue</th><th>status</th><th>recipient</th><th>action</th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    /* When user clicks Verify in search result -> load into pending via verify endpoint */
    async function verifyFromSearch(tracking) {
      setStatus('verifying...');
      try {
        const res = await fetch(`/api/parcels/${encodeURIComponent(tracking)}/verify`, { method: 'POST' });
        if (!res.ok) { setStatus('verify failed'); return; }
        const info = await res.json();
        pendingVerification = {
          tracking: info.tracking,
          queue: info.queue_number || info.queue || '',
          recipient: info.recipient_name ?? info.recipient ?? '',
          ts: Date.now()
        };
        renderPendingBox();
        openPendingPopup();
        showDetail(info);

        setStatus('Verified ‚Äî fill recipient and re-enter tracking to confirm.');
      } catch (err) {
        setStatus('error: ' + err);
      }
    }

    /* When user clicks Confirm in search result -> move into pending so staff can fill recipient and re-enter tracking */
    function confirmFromSearch(tracking, recipFromSearch) {
      pendingVerification = { tracking: tracking, queue: '', recipient: recipFromSearch || '', ts: Date.now() };
      renderPendingBox();
      setStatus('Loaded into pending ‚Äî edit recipient or re-enter tracking to confirm.');
    }

    /* ---------- Detailed view ---------- */
    function showDetail(info) {
      if (!info) { document.getElementById('detailView').innerHTML = '<div class="muted">No detail</div>'; return; }
      const t = info.tracking || info.tracking_number || '';
      const q = info.queue || info.queue_number || '';
      const r = info.recipient_name || info.recipient || info.recipient;
      const s = info.status || info.state || '';
      document.getElementById('detailView').innerHTML = `<div><strong>Tracking:</strong> ${escapeHtml(t)}</div>
    <div><strong>Queue:</strong> ${escapeHtml(q)}</div>
    <div><strong>Recipient:</strong> ${escapeHtml(r || '---')}</div>
    <div><strong>Status:</strong> ${escapeHtml(s)}</div>`;
    }

    /* ---------- Reports ---------- */

    let chartInst = null;
    let currentReportData = null;

    /* === NEW STATE === */
    let reportEditMode = false;
    let selectedToDelete = new Set();

    /* ---------- init ---------- */
    async function initReports() {
      await loadReportValues();
    }

    /* ---------- period values ---------- */
    async function loadReportValues() {
      const p = document.getElementById('r_period').value;
      const res = await fetch(`/api/reports/dates?period=${p}`);
      if (!res.ok) return;

      const arr = await res.json();
      const sel = document.getElementById('r_periodValues');
      sel.innerHTML = '';

      if (arr.length === 0) {
        sel.add(new Option('No data', ''));
        return;
      }

      arr.forEach(r => {
        let label = r.period;
        if (p === 'daily' && label.length === 8) label = `${label.slice(0, 4)}-${label.slice(4, 6)}-${label.slice(6)}`;
        if (p === 'monthly' && label.length === 6) label = `${label.slice(0, 4)}-${label.slice(4, 6)}`;
        sel.add(new Option(`${label} (${r.count})`, r.period));
      });
    }

    document.getElementById('r_period')
      .addEventListener('change', loadReportValues);

    /* ---------- load report ---------- */
    async function loadReport() {
      const p = document.getElementById('r_period').value;
      const val = document.getElementById('r_periodValues').value || '';

      const sres = await fetch(`/api/reports/summary?period=${encodeURIComponent(p)}&date=${encodeURIComponent(val)}`);
      const sdata = await sres.json();

      document.getElementById('summary').innerHTML = `
    <div style="display:flex;gap:12px">
      <div class="pill">Check-in: <strong>${sdata.checkin}</strong></div>
      <div class="pill">Check-out: <strong>${sdata.checkout}</strong></div>
      <div class="pill">Remaining: <strong>${sdata.remaining}</strong></div>
    </div>
  `;

      currentReportData = sdata.items || [];
      renderReportTable(currentReportData);

      const tres = await fetch(`/api/reports/timeseries?period=${encodeURIComponent(p)}&start=${encodeURIComponent(val)}`);
      const tdata = await tres.json();
      renderChart(tdata.labels, tdata.checkin, tdata.checkout, p);
    }

    /* ---------- table ---------- */
    function renderReportTable(items) {
      if (!items || items.length === 0) {
        document.getElementById('reportTable').innerHTML = '<div class="muted">No items</div>';
        return;
      }

      const rows = items.map(i => `
    <tr>
      ${reportEditMode ? `
        <td>
          <input type="checkbox"
            onchange="toggleSelect('${escapeJs(i.tracking)}', this.checked)">
        </td>` : ''
        }
      <td>${escapeHtml(i.tracking)}</td>
      <td>${escapeHtml(i.queue)}</td>
      <td>${escapeHtml(i.status)}</td>
      <td>${escapeHtml(i.recipient || '')}</td>
    </tr>
  `).join('');

      document.getElementById('reportTable').innerHTML = `
    <table>
      <thead>
        <tr>
          ${reportEditMode ? '<th></th>' : ''}
          <th>tracking</th>
          <th>queue</th>
          <th>status</th>
          <th>recipient</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
    }

    /* ---------- edit mode ---------- */
    function toggleReportEdit() {
      reportEditMode = !reportEditMode;
      selectedToDelete.clear();
      document.getElementById('removeBtn').disabled = true;
      renderReportTable(currentReportData);
    }

    function toggleSelect(tracking, checked) {
      if (checked) selectedToDelete.add(tracking);
      else selectedToDelete.delete(tracking);

      document.getElementById('removeBtn').disabled =
        selectedToDelete.size === 0;
    }

    /* ---------- delete ---------- */
    async function removeSelected() {
      if (selectedToDelete.size === 0) return;

      if (!confirm(`Delete ${selectedToDelete.size} parcel(s)?`)) return;

      const res = await fetch('/api/parcels/bulk_delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ trackings: Array.from(selectedToDelete) })
      });

      if (!res.ok) {
        alert('Delete failed');
        return;
      }

      reportEditMode = false;
      selectedToDelete.clear();
      await loadReport();
    }

    /* ---------- chart ---------- */
    function renderChart(labels, checkin, checkout, period) {
      const formattedLabels = labels.map(l => {
        if (period === 'daily' && l.length === 8) return `${l.slice(0, 4)}-${l.slice(4, 6)}-${l.slice(6)}`;
        if (period === 'monthly' && l.length === 6) return `${l.slice(0, 4)}-${l.slice(4, 6)}`;
        return l;
      });

      const ctx = document.getElementById('summaryChart').getContext('2d');
      if (chartInst) chartInst.destroy();

      chartInst = new Chart(ctx, {
        type: 'line',
        data: {
          labels: formattedLabels,
          datasets: [
            { label: 'Check-in', data: checkin, tension: .2 },
            { label: 'Check-out', data: checkout, tension: .2 }
          ]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });
    }

    /* ---------- export ---------- */
    function exportReport(fmt) {
      const p = document.getElementById('r_period').value;
      const val = document.getElementById('r_periodValues').value || '';
      window.open(`/api/reports/export?period=${encodeURIComponent(p)}&date=${encodeURIComponent(val)}&fmt=${fmt}`);
    }

    /* ---------- Utilities ---------- */
    function setStatus(s) { try { document.getElementById('scanStatus').innerText = s; } catch (e) { } }
    function escapeHtml(s) { return String(s || '').replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c])); }
    function escapeAttr(s) { return (String(s || '').replace(/"/g, '&quot;')); }
    function escapeJs(s) { return String(s || '').replace(/'/g, "\\'").replace(/"/g, '\\"'); }
    async function safeJson(res) { try { return await res.json(); } catch (e) { return {}; } }

    /* optional: refresh recent list if you have an element (not implemented here) */
    function refreshRecentIfExists() {
      // if you maintain a "recent" list, call /api/parcels and re-render it.
    }

    /* initialize report values on load */
    window.addEventListener('load', () => { if (document.querySelector('.tabBtn.active').dataset.tab === 'reports') initReports(); });



    function startCamera() {

      if (mainScanner) return
      document.getElementById("cameraOverlay").classList.remove("hidden")
      cameraLocked = false
      mainScanner = new Html5Qrcode("reader")

      Html5Qrcode.getCameras().then(cams => {

        if (!cams.length) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á")

        const camId = cams[cams.length - 1].id

        mainScanner.start(
          camId,
          { fps: 10, qrbox: 220 },
          txt => {
            if (cameraLocked) return
            cameraLocked = true

            handleScan(txt.trim())
            setTimeout(stopCamera, 400)
          }
        )
      }).catch(e => alert(e))
    }


    function stopCamera() {
      if (!mainScanner) return

      mainScanner.stop().then(() => {
        mainScanner.clear()
        mainScanner = null
        cameraLocked = false

        document.getElementById("cameraOverlay").classList.add("hidden")
      })
    }




    async function startCameraConfirm() {

      if (confirmScanner || confirmStopping) return

      const recipientInput = document.getElementById('pendingRecipientInput')

      if (!recipientInput || !recipientInput.value.trim()) {
        openRecipientPopup()
        return
      }
      document.getElementById("confirmCameraOverlay").classList.remove("hidden")

      cameraLocked = false
      setStatus('Scanning for confirm...')

      confirmScanner = new Html5Qrcode("confirmReader")

      const cams = await Html5Qrcode.getCameras()

      if (!cams.length) {
        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á")
        confirmScanner = null
        return
      }

      const camId = cams[cams.length - 1].id

      await confirmScanner.start(
        camId,
        { fps: 10, qrbox: 250 },
        async txt => {

          if (cameraLocked) return
          cameraLocked = true

          const scanned = txt.trim()

          if (pendingVerification && scanned === pendingVerification.tracking) {

            const recipientToSend = recipientInput.value.trim()
            doConfirmPickup(scanned, recipientToSend)

          } else {
            openMismatchPopup()
          }

          await stopConfirmCamera()
        }
      )
    }
    async function stopConfirmCamera() {

      if (!confirmScanner) return

      confirmStopping = true

      try {
        await confirmScanner.stop()
        confirmScanner.clear()
      } catch { }

      confirmScanner = null
      cameraLocked = false
      confirmStopping = false

      document.getElementById("confirmCameraOverlay").classList.add("hidden")
    }



    /* popup helpers */
    function showPopup(q, t) {
      popupQueue.innerText = q || "-"
      popupTracking.innerText = t || ""
      queuePopup.classList.remove("hidden")
      queuePopup.classList.add("flex")
    }
    function closePopup() {
      queuePopup.classList.add("hidden")
      queuePopup.classList.remove("flex")
    }

    function openPendingPopup() {
      pendingPopup.classList.remove("hidden")
      pendingPopup.classList.add("flex")

      document.querySelectorAll(".modeBtn")
        .forEach(b => b.classList.remove("activeMode"))

      document.getElementById("manualConfirmBox").style.display = "none"
    }

    function closePendingPopup() {

      if (confirmScanner) {
        stopConfirmCamera()
      }

      pendingPopup.classList.add("hidden")
      pendingPopup.classList.remove("flex")
    }


    function openAlreadyPopup() {
      alreadyPopup.classList.remove("hidden")
      alreadyPopup.classList.add("flex")
    }

    function closeAlreadyPopup() {
      alreadyPopup.classList.add("hidden")
      alreadyPopup.classList.remove("flex")
    }
    function openRecipientPopup() {
      recipientPopup.classList.remove("hidden")
      recipientPopup.classList.add("flex")
    }

    function closeRecipientPopup() {
      recipientPopup.classList.add("hidden")
      recipientPopup.classList.remove("flex")

      const r = document.getElementById("pendingRecipientInput")
      r?.focus()
    }
    function openMismatchPopup() {
      mismatchPopup.classList.remove("hidden")
      mismatchPopup.classList.add("flex")
    }

    function closeMismatchPopup() {
      mismatchPopup.classList.add("hidden")
      mismatchPopup.classList.remove("flex")

      cameraLocked = false
    }
    function openNotFoundPopup() {
      notFoundPopup.classList.remove("hidden")
      notFoundPopup.classList.add("flex")
    }

    function closeNotFoundPopup() {
      notFoundPopup.classList.add("hidden")
      notFoundPopup.classList.remove("flex")
    }

function showSuccessPopup(tracking, queue, recipient){
  const box = document.getElementById("successPopup")
  const info = document.getElementById("successInfo")

  info.innerHTML = `
 ${escapeHtml(tracking)}<br>
‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏¥‡∏ß: ${escapeHtml(queue || "-")}<br>
‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö: ${escapeHtml(recipient || "-")}
`

  box.classList.remove("hidden")
  box.classList.add("flex")
}

function closeSuccessPopup(){
  const box = document.getElementById("successPopup")

  box.classList.add("hidden")
  box.classList.remove("flex")

  loadWaitingParcels()
  scanInput.focus()
}
function applyDateFilter() {
  const q = document.getElementById("dateFilter").value

  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‚Üí search queue
  if (q && /^\d+$/.test(q)) {
    searchQueue(q)
    return
  }

  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‚Üí date filter
  loadWaitingParcels()
}

function clearDateFilter(){
  document.getElementById("dateFilter").value = ""
  loadWaitingParcels("today")
}

function searchQueue(val) {
  if (!val) {
    loadWaitingParcels()
    return
  }

  fetch(`/api/parcels/search?q=${encodeURIComponent(val)}`)
    .then(r => r.json())
    .then(data => {

      const box = document.getElementById("parcelList")

      if (!data.items || !data.items.length) {
        box.innerHTML = `<div class="text-sm text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏</div>`
        return
      }

      box.innerHTML = data.items.map(p => `
<div onclick="handleScan('${p.tracking}')"
     class="flex justify-between items-center p-4 bg-white rounded-xl mb-2 border cursor-pointer hover:bg-orange-50">

  <div class="flex gap-4">

    <div class="size-10 rounded-full border flex items-center justify-center font-bold">
      ${p.queue ?? "-"}
    </div>

    <div>
      <p class="font-bold">${p.tracking}</p>

      <span class="text-xs bg-orange-100 px-2 rounded">
        ${p.status}
      </span>

      ${p.created_at ? `
      <div class="mt-1">
        <span class="text-xs bg-green-100 text-green-700 px-2 rounded">
          ${new Date(p.created_at).toLocaleString("th-TH",{timeZone:"Asia/Bangkok"})}
        </span>
      </div>` : ``}

    </div>

  </div>
</div>
`).join("")
    })
}

    function logout() { location.href = "/login_admin" }

    async function loadWaitingParcels(date=null){
      try {
        const status = document.getElementById("statusFilter").value || "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"

        let url = `/api/parcels?status=${encodeURIComponent(status)}`

if(date){
  url += `&date=${encodeURIComponent(date)}`
}
        const res = await fetch(url)

        if (!res.ok) throw new Error("‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")

        const data = await res.json()
        const box = document.getElementById("parcelList")

        if (!data.length) {
          box.innerHTML = `<div class="text-sm text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏</div>`
          return
        }

        box.innerHTML = data.map(p => `
<div onclick="handleScan('${p.tracking_number}')"
     class="flex justify-between items-center p-4 bg-white rounded-xl mb-2 border cursor-pointer hover:bg-orange-50">

  <div class="flex gap-4">

    <!-- queue circle -->
    <div class="size-10 rounded-full border flex items-center justify-center font-bold">
      ${p.queue_number ?? "-"}
    </div>

    <div>
      <p class="font-bold">${p.tracking_number}</p>

      <div class="flex items-center gap-2 mt-1">
        <span class="text-xs bg-orange-100 px-2 rounded">
          ${p.status}
        </span>
      </div>
      <div>
      ${p.created_at ? `
<span class="text-xs bg-green-100 text-green-700 px-2 rounded">
${new Date(p.created_at).toLocaleString("th-TH", { timeZone: "Asia/Bangkok" })}
</span>` : ``}
    </div>

  </div>
</div>
</div>
`).join("")

      } catch (e) {
        document.getElementById("parcelList").innerHTML =
          `<div class="text-red-400 text-sm">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</div>`
        console.error(e)
      }
    }

  </script>

</body>

</html>