<!DOCTYPE html>
<html lang="th">

<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>NUDPACK Admin</title>

<script src="https://cdn.tailwindcss.com?plugins=forms"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai+Looped:wght@100..900&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

<script>
tailwind.config={
darkMode:"class",
theme:{extend:{
colors:{primary:"#f95f06"},
fontFamily:{display:["Noto Sans Thai Looped","sans-serif"]}
}}
}
</script>

<style>
.scan-zone{border:2px dashed #e9d8ce}
.latest{background:#fff6e5}
</style>
</head>

<body class="bg-[#fafafa] font-display">

<header class="sticky top-0 bg-white/80 backdrop-blur border-b p-4">
<div class="max-w-xl mx-auto flex justify-between items-center">
<div class="flex gap-3 items-center">
<img src="/static/NUDPACK_LOGO2.png" class="w-14"/>
<div>
<h2 class="font-bold">NUDPACK ADMIN</h2>
<p class="text-xs text-orange-400">Parcel Checkout</p>
</div>
</div>

<button onclick="logout()" class="text-xs text-red-500">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
</div>
</header>

<main class="max-w-xl mx-auto pb-40">

<!-- ================= Scan ================= -->
<section class="p-4">
  <div class="bg-white rounded-xl p-4 scan-zone">

    <label class="text-sm text-primary font-semibold">Scan / Enter Tracking</label>

    <div class="flex mt-2">
      <input id="scanInput" class="flex-1 border rounded-l-lg h-12 px-3"/>

      <button onclick="handleScan(scanInput.value.trim())"
        class="bg-primary text-white px-4 rounded-r-lg">
        <span class="material-symbols-outlined">barcode_scanner</span>
      </button>
    </div>

    <div class="flex gap-3 mt-4">
      <button onclick="startCamera()" class="flex-1 bg-primary text-white rounded-lg h-12">‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
      <button onclick="stopCamera()" class="flex-1 border rounded-lg h-12">‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
    </div>

    <div id="reader" class="mt-3"></div>
    <div id="scanStatus" class="text-sm mt-2"></div>

  </div>
</section>

<!-- ================= Filter ================= -->
<section class="px-4 mt-2">
  <select id="statusFilter"
    class="border rounded-lg px-3 py-2 text-sm w-full"
    onchange="loadWaitingParcels()">

    <option value="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">üì¶ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
    <option value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠</option>
    <option value="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö">üïì ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</option>
    <option value="‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß">‚úÖ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</option>

  </select>
</section>

<!-- ================= Parcel List ================= -->
<section class="px-4 mt-3">
  <h3 class="font-semibold mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏™‡∏î‡∏∏</h3>
  <div id="parcelList"></div>
</section>



<!-- ================= Detail ================= -->
<section class="px-4 mt-6">
  <h3 class="font-bold mb-2">Active Parcel</h3>
  <div id="detailView" class="bg-white rounded-xl p-4 text-sm"></div>
</section>

</main>


<!-- popup -->
<div id="queuePopup" class="fixed inset-0 hidden bg-black/40 items-center justify-center">
<div class="bg-white rounded-xl p-6 w-72 text-center">
<p class="text-gray-400 text-sm">Queue</p>
<div id="popupQueue" class="text-6xl text-primary font-bold"></div>
<p id="popupTracking" class="text-xs text-gray-500 mt-2"></p>
<button onclick="closePopup()" class="mt-4 w-full bg-primary text-white rounded-lg py-2">‡∏ï‡∏Å‡∏•‡∏á</button>
</div>
</div>

<!-- Pending Verify Popup -->
<div id="pendingPopup" class="fixed inset-0 hidden bg-black/40 items-center justify-center z-50">
  <div class="bg-white rounded-xl p-5 w-[90%] max-w-md relative">

    <!-- close -->
    <button onclick="forceClearPending()"
      class="absolute right-3 top-3 text-gray-400 hover:text-red-500 text-xl">
      ‚úï
    </button>

    <h3 class="font-bold mb-2 text-primary">Pending Verification</h3>

    <div id="verifyBox"></div>

  </div>
</div>

<!-- Already Picked Popup -->
<div id="alreadyPopup" class="fixed inset-0 hidden bg-black/40 items-center justify-center z-50">
  <div class="bg-white rounded-xl p-5 w-[90%] max-w-md relative">

    <button onclick="closeAlreadyPopup()"
      class="absolute right-3 top-3 text-gray-400 hover:text-red-500 text-xl">
      ‚úï
    </button>

    <h3 class="font-bold text-red-500 mb-2">‚ö† ‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</h3>

    <div id="alreadyBox" class="text-sm"></div>

    <button onclick="closeAlreadyPopup()"
      class="mt-4 w-full bg-primary text-white rounded-lg py-2">
      ‡∏ï‡∏Å‡∏•‡∏á
    </button>

  </div>
</div>


<script>
    /* ---------------- Tabs ---------------- */
    document.querySelectorAll('.tabBtn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tabBtn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const tab = btn.dataset.tab;
        document.querySelectorAll('.tabContent').forEach(tc => tc.style.display = tc.id === tab ? 'block' : 'none');
        if (tab === 'reports') initReports();
      });
    });

    /* ---------- Globals ---------- */
    let pendingVerification = null;

    /* ---------- Scan input handling ---------- */
    const scanInputEl = document.getElementById('scanInput');
    scanInputEl.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleScan(scanInputEl.value.trim());
    });

    async function handleScan(value) {
      if (!value) return;
      // first scan -> verify
      if (!pendingVerification) {
        setStatus('verifying...');
        try {
          const res = await fetch(`/api/parcels/${encodeURIComponent(value)}/verify`, { method: 'POST' });
          if (!res.ok) {
            const err = await safeJson(res).catch(() => ({ detail: res.statusText }));
            setStatus('Verify failed: ' + (err.detail || res.statusText));
            scanInputEl.value = '';
            return;
          }
          const info = await res.json();
          // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚Üí popup ‡πÅ‡∏à‡πâ‡∏á
          if (info.status === "PICKED_UP" || info.status === "‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß") {

            document.getElementById("alreadyBox").innerHTML = `
              <div><b>Tracking:</b> ${escapeHtml(info.tracking)}</div>
              <div><b>Queue:</b> ${escapeHtml(info.queue_number || info.queue || "-")}</div>
              <div><b>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö:</b> ${escapeHtml(info.recipient_name || info.recipient || "-")}</div>
              <div><b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</b> ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÅ‡∏•‡πâ‡∏ß</div>
            `

            openAlreadyPopup()
            setStatus("‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß")
            scanInputEl.value=""
            return
          }

          const recipientName = info.recipient_name ?? info.recipient ?? '';
          pendingVerification = {
            tracking: info.tracking,
            queue: info.queue_number || info.queue || '',
            recipient: recipientName,
            ts: Date.now()
          };
          renderPendingBox();
          openPendingPopup();
          showDetail(info);

          setStatus('Verified ‚Äî please fill recipient and re-enter tracking to confirm (or scan same tracking again).');
        } catch (err) {
          setStatus('Network error: ' + err);
        } finally {
          scanInputEl.value = '';
        }
        return;
      }

      // second scan -> if matches, perform confirm using recipient in pending box
      if (value === pendingVerification.tracking) {
        const recipientInput = document.getElementById('pendingRecipientInput');
        const recipientToSend = recipientInput ? recipientInput.value.trim() : (pendingVerification.recipient || '');
        await doConfirmPickup(pendingVerification.tracking, recipientToSend);
        return;
      } else {
        setStatus(`Mismatch: scanned ${value} (expected ${pendingVerification.tracking})`);
        scanInputEl.value = '';
        return;
      }
    }

    /* ---------- Render pending verification box ---------- */
    function renderPendingBox() {
      if (!pendingVerification) {
        document.getElementById('verifyBox').innerHTML = '';
        return;
      }
      const rec = pendingVerification.recipient || '';
      document.getElementById('verifyBox').innerHTML = `
<div style="padding:12px;border-radius:8px;background:#fff7ed;border:1px solid #f2c6a0">

  <div>
    <strong>‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô:</strong>
    ${escapeHtml(pendingVerification.tracking)}
    <small>[‡∏Ñ‡∏¥‡∏ß ${escapeHtml(pendingVerification.queue)}]</small>
  </div>

  <div class="small" style="margin-top:6px">
    ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ):<br>
    <input id="pendingRecipientInput"
      style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd"
      value="${escapeAttr(rec)}"
      placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ï‡∏£‡∏ô‡∏¥‡∏™‡∏¥‡∏ï" />
  </div>

  <div class="small" style="margin-top:8px">
    ‡∏Å‡∏£‡∏≠‡∏Å Tracking ‡∏ã‡πâ‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô:<br>
    <input id="pendingConfirmTracking"
      style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd"
      placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå Tracking ‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á" />
  </div>

  <div class="small" style="margin-top:8px">
    ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô:
    <ul style="margin:6px 0 0 18px;padding:0">
      <li>‡∏™‡πÅ‡∏Å‡∏ô Tracking ‡πÄ‡∏î‡∏¥‡∏°‡∏ã‡πâ‡∏≥‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</li>
      <li>‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå Tracking ‡∏•‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏‚Äù</li>
    </ul>
  </div>

  <div style="margin-top:12px" class="flex gap-2">
    <button id="pendingConfirmBtn"
      class="flex-1 bg-primary text-white rounded-lg py-2 disabled:opacity-40"
      disabled>
      ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏
    </button>

    <button class="flex-1 border rounded-lg py-2"
      onclick="startCameraConfirm()">
      üì∑ ‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
    </button>

    <button class="flex-1 border rounded-lg py-2 text-red-500"
      onclick="forceClearPending()">
      ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
    </button>
  </div>

</div>`;


      const confirmField = document.getElementById('pendingConfirmTracking');
      const recipientField = document.getElementById('pendingRecipientInput');
      const confirmBtn = document.getElementById('pendingConfirmBtn');

      function updatePendingControls() {
        const a = (recipientField.value || '').trim().length > 0;
        const b = (confirmField.value || '').trim().length > 0 && (confirmField.value.trim() === pendingVerification.tracking);
        confirmBtn.disabled = !(a && b);
      }

      confirmField.addEventListener('input', updatePendingControls);
      recipientField.addEventListener('input', updatePendingControls);

      confirmBtn.addEventListener('click', async () => {
        const recipientToSend = (document.getElementById('pendingRecipientInput').value || '').trim();
        await doConfirmPickup(pendingVerification.tracking, recipientToSend);
      });

      if (recipientField) recipientField.focus();
    }

    /* ---------- Confirm pickup (send recipient_name with request) ---------- */
    async function doConfirmPickup(tracking, recipientToSend) {
      setStatus('confirming pickup...');
      try {
        const res = await fetch(`/api/parcels/${encodeURIComponent(tracking)}/confirm_pickup`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ recipient_name: recipientToSend, scanner_id: 'admin_ui' })
        });
        const j = await safeJson(res);
        if (res.ok && (j.ok === true || j.ok === undefined)) {
          setStatus(`Confirmed pickup ${tracking}`);
          showDetail({ tracking: tracking, queue: pendingVerification ? pendingVerification.queue : '', recipient: recipientToSend, status: '‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß' });
          pendingVerification = null;
          closePendingPopup();
          document.getElementById('verifyBox').innerHTML = '';

          // optionally refresh recent list
          refreshRecentIfExists();
        } else {
          setStatus('Confirm failed: ' + (j.message || j.detail || JSON.stringify(j)));
        }
      } catch (err) {
        setStatus('Network error: ' + err);
      } finally {
        try { document.getElementById('scanInput').value = ''; } catch (e) { }
      }
    }

    /* Force clear pending */
    function forceClearPending() {
      pendingVerification = null;
      document.getElementById('verifyBox').innerHTML = '';
      closePendingPopup();
      setStatus('waiting');
    }

    /* ---------- Search ---------- */
    document.getElementById('searchInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') doSearch(); });
    async function doSearch() {
      const q = document.getElementById('searchInput').value.trim();
      if (!q) return alert('Please input tracking or queue');
      const res = await fetch(`/api/parcels/search?q=${encodeURIComponent(q)}`);
      if (!res.ok) return alert('Search failed');
      const data = await res.json();
      if (data.count === 0) { document.getElementById('searchResults').innerHTML = '<div class="muted">No results</div>'; return; }
      const rows = data.items.map(i => `<tr>
    <td>${escapeHtml(i.tracking)}</td>
    <td>${escapeHtml(i.queue)}</td>
    <td>${escapeHtml(i.status)}</td>
    <td>${escapeHtml(i.recipient || '')}</td>
    </tr>`).join('');
      document.getElementById('searchResults').innerHTML = `<table><thead><tr><th>tracking</th><th>queue</th><th>status</th><th>recipient</th><th>action</th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    /* When user clicks Verify in search result -> load into pending via verify endpoint */
    async function verifyFromSearch(tracking) {
      setStatus('verifying...');
      try {
        const res = await fetch(`/api/parcels/${encodeURIComponent(tracking)}/verify`, { method: 'POST' });
        if (!res.ok) { setStatus('verify failed'); return; }
        const info = await res.json();
        pendingVerification = {
          tracking: info.tracking,
          queue: info.queue_number || info.queue || '',
          recipient: info.recipient_name ?? info.recipient ?? '',
          ts: Date.now()
        };
        renderPendingBox();
        openPendingPopup();
        showDetail(info);

        setStatus('Verified ‚Äî fill recipient and re-enter tracking to confirm.');
      } catch (err) {
        setStatus('error: ' + err);
      }
    }

    /* When user clicks Confirm in search result -> move into pending so staff can fill recipient and re-enter tracking */
    function confirmFromSearch(tracking, recipFromSearch) {
      pendingVerification = { tracking: tracking, queue: '', recipient: recipFromSearch || '', ts: Date.now() };
      renderPendingBox();
      setStatus('Loaded into pending ‚Äî edit recipient or re-enter tracking to confirm.');
    }

    /* ---------- Detailed view ---------- */
    function showDetail(info) {
      if (!info) { document.getElementById('detailView').innerHTML = '<div class="muted">No detail</div>'; return; }
      const t = info.tracking || info.tracking_number || '';
      const q = info.queue || info.queue_number || '';
      const r = info.recipient_name || info.recipient || info.recipient;
      const s = info.status || info.state || '';
      document.getElementById('detailView').innerHTML = `<div><strong>Tracking:</strong> ${escapeHtml(t)}</div>
    <div><strong>Queue:</strong> ${escapeHtml(q)}</div>
    <div><strong>Recipient:</strong> ${escapeHtml(r || '---')}</div>
    <div><strong>Status:</strong> ${escapeHtml(s)}</div>`;
    }

    /* ---------- Reports ---------- */

    let chartInst = null;
    let currentReportData = null;

    /* === NEW STATE === */
    let reportEditMode = false;
    let selectedToDelete = new Set();

    /* ---------- init ---------- */
    async function initReports() {
      await loadReportValues();
    }

    /* ---------- period values ---------- */
    async function loadReportValues() {
      const p = document.getElementById('r_period').value;
      const res = await fetch(`/api/reports/dates?period=${p}`);
      if (!res.ok) return;

      const arr = await res.json();
      const sel = document.getElementById('r_periodValues');
      sel.innerHTML = '';

      if (arr.length === 0) {
        sel.add(new Option('No data', ''));
        return;
      }

      arr.forEach(r => {
        let label = r.period;
        if (p === 'daily' && label.length === 8) label = `${label.slice(0, 4)}-${label.slice(4, 6)}-${label.slice(6)}`;
        if (p === 'monthly' && label.length === 6) label = `${label.slice(0, 4)}-${label.slice(4, 6)}`;
        sel.add(new Option(`${label} (${r.count})`, r.period));
      });
    }

    document.getElementById('r_period')
      .addEventListener('change', loadReportValues);

    /* ---------- load report ---------- */
    async function loadReport() {
      const p = document.getElementById('r_period').value;
      const val = document.getElementById('r_periodValues').value || '';

      const sres = await fetch(`/api/reports/summary?period=${encodeURIComponent(p)}&date=${encodeURIComponent(val)}`);
      const sdata = await sres.json();

      document.getElementById('summary').innerHTML = `
    <div style="display:flex;gap:12px">
      <div class="pill">Check-in: <strong>${sdata.checkin}</strong></div>
      <div class="pill">Check-out: <strong>${sdata.checkout}</strong></div>
      <div class="pill">Remaining: <strong>${sdata.remaining}</strong></div>
    </div>
  `;

      currentReportData = sdata.items || [];
      renderReportTable(currentReportData);

      const tres = await fetch(`/api/reports/timeseries?period=${encodeURIComponent(p)}&start=${encodeURIComponent(val)}`);
      const tdata = await tres.json();
      renderChart(tdata.labels, tdata.checkin, tdata.checkout, p);
    }

    /* ---------- table ---------- */
    function renderReportTable(items) {
      if (!items || items.length === 0) {
        document.getElementById('reportTable').innerHTML = '<div class="muted">No items</div>';
        return;
      }

      const rows = items.map(i => `
    <tr>
      ${reportEditMode ? `
        <td>
          <input type="checkbox"
            onchange="toggleSelect('${escapeJs(i.tracking)}', this.checked)">
        </td>` : ''
        }
      <td>${escapeHtml(i.tracking)}</td>
      <td>${escapeHtml(i.queue)}</td>
      <td>${escapeHtml(i.status)}</td>
      <td>${escapeHtml(i.recipient || '')}</td>
    </tr>
  `).join('');

      document.getElementById('reportTable').innerHTML = `
    <table>
      <thead>
        <tr>
          ${reportEditMode ? '<th></th>' : ''}
          <th>tracking</th>
          <th>queue</th>
          <th>status</th>
          <th>recipient</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
    }

    /* ---------- edit mode ---------- */
    function toggleReportEdit() {
      reportEditMode = !reportEditMode;
      selectedToDelete.clear();
      document.getElementById('removeBtn').disabled = true;
      renderReportTable(currentReportData);
    }

    function toggleSelect(tracking, checked) {
      if (checked) selectedToDelete.add(tracking);
      else selectedToDelete.delete(tracking);

      document.getElementById('removeBtn').disabled =
        selectedToDelete.size === 0;
    }

    /* ---------- delete ---------- */
    async function removeSelected() {
      if (selectedToDelete.size === 0) return;

      if (!confirm(`Delete ${selectedToDelete.size} parcel(s)?`)) return;

      const res = await fetch('/api/parcels/bulk_delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ trackings: Array.from(selectedToDelete) })
      });

      if (!res.ok) {
        alert('Delete failed');
        return;
      }

      reportEditMode = false;
      selectedToDelete.clear();
      await loadReport();
    }

    /* ---------- chart ---------- */
    function renderChart(labels, checkin, checkout, period) {
      const formattedLabels = labels.map(l => {
        if (period === 'daily' && l.length === 8) return `${l.slice(0, 4)}-${l.slice(4, 6)}-${l.slice(6)}`;
        if (period === 'monthly' && l.length === 6) return `${l.slice(0, 4)}-${l.slice(4, 6)}`;
        return l;
      });

      const ctx = document.getElementById('summaryChart').getContext('2d');
      if (chartInst) chartInst.destroy();

      chartInst = new Chart(ctx, {
        type: 'line',
        data: {
          labels: formattedLabels,
          datasets: [
            { label: 'Check-in', data: checkin, tension: .2 },
            { label: 'Check-out', data: checkout, tension: .2 }
          ]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });
    }

    /* ---------- export ---------- */
    function exportReport(fmt) {
      const p = document.getElementById('r_period').value;
      const val = document.getElementById('r_periodValues').value || '';
      window.open(`/api/reports/export?period=${encodeURIComponent(p)}&date=${encodeURIComponent(val)}&fmt=${fmt}`);
    }

    /* ---------- Utilities ---------- */
    function setStatus(s) { try { document.getElementById('scanStatus').innerText = s; } catch (e) { } }
    function escapeHtml(s) { return String(s || '').replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c])); }
    function escapeAttr(s) { return (String(s || '').replace(/"/g, '&quot;')); }
    function escapeJs(s) { return String(s || '').replace(/'/g, "\\'").replace(/"/g, '\\"'); }
    async function safeJson(res) { try { return await res.json(); } catch (e) { return {}; } }

    /* optional: refresh recent list if you have an element (not implemented here) */
    function refreshRecentIfExists() {
      // if you maintain a "recent" list, call /api/parcels and re-render it.
    }

    /* initialize report values on load */
    window.addEventListener('load', () => { if (document.querySelector('.tabBtn.active').dataset.tab === 'reports') initReports(); });

    /* ---------- Camera Scan (ADD-ON) ---------- */
    let qrScanner = null;
    let cameraLocked = false;

    function startCamera() {
      if (qrScanner) return;

      cameraLocked = false;
      qrScanner = new Html5Qrcode("reader");

      Html5Qrcode.getCameras().then(cams => {
        if (!cams.length) {
          setStatus('No camera found');
          return;
        }

        const camId = cams[cams.length - 1].id; // back camera

        qrScanner.start(
          camId,
          { fps: 10, qrbox: 250 },
          text => {
            if (cameraLocked) return;
            cameraLocked = true;

            stopCamera();

            // ‚≠ê ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÉ‡∏ä‡πâ logic ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            handleScan(text.trim());
          }
        );
      }).catch(err => {
        setStatus('Camera error');
        console.error(err);
      });
    }

    function stopCamera() {
      if (!qrScanner) return;
      qrScanner.stop().then(() => {
        qrScanner.clear();
        qrScanner = null;
        cameraLocked = false;
      });
    }

    function startCameraConfirm() {
      if (qrScanner) return;

      cameraLocked = false;
      setStatus('Scanning for confirm...');

      qrScanner = new Html5Qrcode("reader");

      Html5Qrcode.getCameras().then(cams => {
        if (!cams.length) {
          setStatus('No camera found');
          return;
        }

        const camId = cams[cams.length - 1].id;

        qrScanner.start(
          camId,
          { fps: 10, qrbox: 250 },
          text => {
            if (cameraLocked) return;
            cameraLocked = true;

            stopCamera();

            const scanned = text.trim();

            // ‚≠ê ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÉ‡∏ä‡πâ logic confirm ‡πÄ‡∏î‡∏¥‡∏°
            if (pendingVerification && scanned === pendingVerification.tracking) {
              const recipientInput = document.getElementById('pendingRecipientInput');
              const recipientToSend = recipientInput ? recipientInput.value.trim() : '';
              doConfirmPickup(scanned, recipientToSend);
            } else {
              setStatus(`Mismatch: scanned ${scanned}`);
            }
          }
        );
      });
    }



/* popup helpers */
function showPopup(q,t){
popupQueue.innerText=q||"-"
popupTracking.innerText=t||""
queuePopup.classList.remove("hidden")
queuePopup.classList.add("flex")
}
function closePopup(){
queuePopup.classList.add("hidden")
queuePopup.classList.remove("flex")
}

function openPendingPopup(){
  pendingPopup.classList.remove("hidden")
  pendingPopup.classList.add("flex")
}

function closePendingPopup(){
  pendingPopup.classList.add("hidden")
  pendingPopup.classList.remove("flex")
}

function openAlreadyPopup(){
  alreadyPopup.classList.remove("hidden")
  alreadyPopup.classList.add("flex")
}

function closeAlreadyPopup(){
  alreadyPopup.classList.add("hidden")
  alreadyPopup.classList.remove("flex")
}



function logout(){location.href="/login_admin"}

async function loadWaitingParcels() {
  const status = document.getElementById("statusFilter").value

  let url = "/api/parcels"

  if (status && status !== "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î") {
    url += `?status=${encodeURIComponent(status)}`
  }

  const res = await fetch(url)
  const data = await res.json()

  const box = document.getElementById("parcelList")

  box.innerHTML = data.map(p => `
  <div onclick="handleScan('${p.tracking_number}')"
       class="bg-white rounded-lg p-3 mb-2 border cursor-pointer hover:bg-orange-50">

    <b>${p.queue_number}</b> ‚Äî ${p.tracking_number}
    <div class="text-xs text-gray-500">${p.status}</div>

  </div>
`).join("")

}
window.addEventListener("load", loadWaitingParcels)

</script>

</body>
</html>
